"""
Streamlit UI –¥–ª—è RAG-–±–æ—Ç–∞ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.
–ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ streamlit-authenticator –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞.
"""

import os
import sys
import streamlit as st
from pathlib import Path
from typing import Optional

sys.path.insert(0, str(Path(__file__).parent / "src"))

from rag_service import create_rag_service, RAGService
from dotenv import load_dotenv

try:
    import streamlit_authenticator as stauth
    import yaml
    from yaml.loader import SafeLoader
    AUTH_AVAILABLE = True
except ImportError:
    AUTH_AVAILABLE = False
    st.warning("streamlit-authenticator –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞.")

load_dotenv()

st.set_page_config(
    page_title="RAG HF Bot - –ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="expanded"
)

def check_authentication():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    
    if not AUTH_AVAILABLE:
        return True
    
    if os.getenv("ENABLE_AUTH", "false").lower() != "true":
        return True
    
    config_path = Path(__file__).parent / "config.yaml"
    if not config_path.exists():
        st.error("–§–∞–π–ª config.yaml –Ω–µ –Ω–∞–π–¥–µ–Ω. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞.")
        return True
    
    try:
        with open(config_path) as file:
            config = yaml.load(file, Loader=SafeLoader)
        
        authenticator = stauth.Authenticate(
            config['credentials'],
            config['cookie']['name'],
            config['cookie']['key'],
            config['cookie']['expiry_days']
        )
        
        name, authentication_status, username = authenticator.login('–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É', 'main')
        
        if authentication_status == False:
            st.error('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å')
            return False
        elif authentication_status == None:
            st.warning('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å')
            return False
        elif authentication_status:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
            authenticator.logout('–í—ã—Ö–æ–¥', 'sidebar')
            st.sidebar.success(f'–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: **{name}**')
            return True
            
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
        return True  # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–æ—Å—Ç—É–ø

if not check_authentication():
    st.stop()

if "rag_service" not in st.session_state:
    st.session_state.rag_service = None
    st.session_state.initialized = False

if "messages" not in st.session_state:
    st.session_state.messages = []

st.title("–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç")
st.markdown("–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (–ì–û–°–¢—ã, –°–ü, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)")

if not st.session_state.initialized:
    with st.spinner("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG-—Å–µ—Ä–≤–∏—Å–∞..."):
        try:
            st.session_state.rag_service = create_rag_service()
            st.session_state.initialized = True
            st.success("–°–µ—Ä–≤–∏—Å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            st.stop()

# –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ streamlit_app.py...

